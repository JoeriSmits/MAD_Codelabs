<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/codelab-components/google-codelab.html">
<link rel="import" href="../../../bower_components/codelab-components/google-codelab-step.html">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<dom-module id="CodeLab-Firebase-app">
    <template>
        <style>
            :host {
                display: block;
                font-family: 'Open Sans', sans-serif;
            }

            aside {
                border-color: #6a6;
                background: #ded;
                color: #464;
            }

            aside.danger {
                border-color: #aa6666;
                background: #eedddd;
                color: #664444;
            }

            ol,
            ul {
                margin: 2em 0;
            }

            #moveIcon {
                transform: rotate(180deg);
            }

            google-codelab::content .donebutton {
                display: none;
            }
        </style>

        <google-codelab title="Android CodeLab: Chatapplicatie met Firebase" last-updated="2017-01-11">
            <google-codelab-step label="Firebase installeren" step="1" duration="8">
              <aside>
                <p>
                  Deze codelab is geschreven voor Android Studio <strong>versie 1.5</strong> en hoger.
                  Voor deze codelab is al een Firebase applicatie aangemaakt in de Firebase console, <strong>dit hoef je dus niet zelf te doen!</strong>
                </p>
              </aside>
                  <ol>
                    <li>Maak een nieuw Android Studio project aan (gebruik de volgende package identifier: <code>nl.han.ica.mad.android.firebasedemo</code>).</li>
                    <li>We gaan <a href="https://developer.android.com/reference/android/support/v7/widget/RecyclerView.html" target="_blank">RecyclerViews</a> gebruiken, dus <strong>kies voor een minimum API level van 23.</strong></li>
                    <li>Open de root <code>build.gradle</code> (deze staat in Android Studio gemarkeerd als <i>Project: Android</i>) en voeg
                        de google-services plugin toe aan je project:</li>
                    <p>
                        <pre><code><span>
buildscript {
    // ...
    dependencies {
        // ...
        classpath 'com.google.gms:google-services:3.0.0'
    }
}
            </span></code></pre>
                    </p>
                    <li>Voeg vervolgens de Firebase library toe aan de project <code>build.gradle</code> (deze staat in Android Studio gemarkeerd
                        als <i>Module: app</i>)</li>
                    <p>
                        <pre><code><span>
apply plugin: 'com.android.application'

android {
  // ...
}

dependencies {
  // ...
  compile 'com.google.firebase:firebase-core:10.0.1'

  // Getting a "Could not find" error? Make sure you have
  // the latest Google Repository in the Android SDK manager
}

// ADD THIS AT THE BOTTOM
apply plugin: 'com.google.gms.google-services'</span></code></pre>
                    </p>
                    <aside>
                      <p>
                        Als je het automatisch synchronizeren van je project met de gradle configuraties uit hebt staan, dan moet je dit handmatig doen door de <strong>"Sync project with Gradle files"</strong> knop in te drukken.
                      </p>
                    </aside>
                    <p><img src="http://i.imgur.com/ve5JYNx.png" alt="Sync project with Gradle files" /></p>
                    <p><i>Protip: Kan je de knop niet vinden? Gebruikt</i> <code>ctrl-shift-a</code> <i>om het commando interface te openen en typ "Sync project with Gradle files".</i></p>
                    <li>Gebruik vervolgens de voorbereidde firebase configuratie (<a href="https://s3.eu-central-1.amazonaws.com/mad-codelab/google-services.json">download</a>)
                        en voeg deze toe aan de <code>app</code> map van je nieuwe project</li>
                    <p><img src="http://i.imgur.com/6JRYG0E.png" alt="Installatieinstructies" /></p>
                </ol>
                <strong>Firebase is nu geÃ¯nstalleerd! ðŸŽ‰ ðŸ™Œ</strong>
            </google-codelab-step>
            <google-codelab-step label="Het message object" step="2" duration="3">
                Nu je Firebase succesvol hebt geinstalleerd is het tijd om de chatapplicatie te gaan maken. Om te voorkomen dat het te lang
                duurt om te codelab te volgen worden sommige delen code aangeleverd.
                <ol>
                    <li>Indien dit niet automatisch is gebeurd, voeg een lege activity toe aan je project.</li>
                    <aside>
                      <p>
                        De Firebase database bevat een lijst van berichten die uit drie onderdelen bestaat, namelijk: de sender,
                        message en timestamp. Om wat makkelijker met deze data om te gaan maken we een message object aan
                        die deze velden bevat. <strong>Al deze velden worden opgeslagen als een String</strong>.
                      </p>
                    </aside>
                    <li>Maak een message object aan</li>
                    <li>Geef het nieuwe message object een constructor waarmee je de sender, message en timestamp set.</li>
                  </ol>
            </google-codelab-step>
            <google-codelab-step label="Richt de activity in" step="3" duration="8">
                <ol>
                    <li>Nu is het tijd om je activity in te richten. Voor het gemak wordt de layout <a href="http://pastebin.com/dkfzibyp">aangeleverd</a>.
                        Deze kun je vervolgens in de <code>onCreate()</code> als layout instellen (hint: <code>setContentView()</code>).</li>
                    <li>Vul <code>app/src/main/res/values/colors.xml</code> aan met de <a href="http://pastebin.com/9Ne9WXFH" target="_blank">volgende kleuren.</a></li>
                    <aside>
                      <p>
                        Voor het weergeven van de messages wordt een RecyclerView gebruikt. RecyclerView is de efficiÃ«ntste implementatie van een ListView.
                      </p>
                    </aside>
                    <li>Voor deze RecyclerView wordt de volgende Adapter aangeleverd.</li>
                    <p>
                    <pre><code><span>
import android.content.Context;
import android.os.Build;
import android.support.annotation.RequiresApi;
import android.support.v7.widget.RecyclerView;
import android.view.Gravity;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.LinearLayout;
import android.widget.TextView;

import java.util.List;

import nl.han.ica.mad.android.firebasedemo.model.Message;

/**
 * Provides a RecyclerView Adapter to display messages fetched from the FireBase reference.
 */
public class MessageAdapter extends RecyclerView.Adapter<MessageAdapter.ViewHolder> {

    private List<Message> messages;
    private String currentUser;
    private Context context;

    /**
     * Constructor to instantiate a new MessageAdapter.
     *
     * @param messages The list of messages fetched by the {@link com.google.firebase.database.DatabaseReference FireBase database reference}
     * @param currentUser The current logged in user
     * @param context The context of this MessageAdapter (i.e. {@link nl.han.ica.mad.android.firebasedemo.MainActivity})
     */
    MessageAdapter(List<Message> messages, String currentUser, Context context) {
        this.context = context;
        this.messages = messages;
        this.currentUser = currentUser;
    }

    @Override
    public ViewHolder onCreateViewHolder(ViewGroup parent, int viewType) {
        Context context = parent.getContext();
        LayoutInflater inflater = LayoutInflater.from(context);
        View messageView = inflater.inflate(R.layout.single_message, parent, false);
        return new ViewHolder(messageView);
    }

    @RequiresApi(api = Build.VERSION_CODES.M)
    @Override
    public void onBindViewHolder(ViewHolder holder, int position) {
        Message message = messages.get(position);
        holder.username.setText(String.format(context.getResources().getString(R.string.sender_name), message.username));
        holder.message.setText(message.message);

        if (currentUser.equals(message.username)) {
            holder.container.setBackgroundColor(context.getColor(R.color.messageBackgroundUser));
            holder.wrapper.setGravity(Gravity.END);
        } else {
            holder.container.setBackgroundColor(context.getColor(R.color.messageBackground));
            holder.wrapper.setGravity(Gravity.START);
        }
    }

    @Override
    public int getItemCount() {
        return messages.size();
    }

    class ViewHolder extends RecyclerView.ViewHolder {
        TextView message;
        TextView username;
        LinearLayout container;
        LinearLayout wrapper;

        ViewHolder(View itemView) {
            super(itemView);
            message = (TextView) itemView.findViewById(R.id.message);
            username = (TextView) itemView.findViewById(R.id.username);
            container = (LinearLayout) itemView.findViewById(R.id.messageContainer);
            wrapper = (LinearLayout) itemView.findViewById(R.id.messageWrapper);
        }
    }
}
                    </span></code></pre>
                    </p>
                    <li>Declareer in je Activity vijf velden: een String username met je naam (dus <code>String username = "JouwNaam";</code>),
                        een RecyclerView, een DatabaseReference, een List
                        <Message> en een MessageAdapter. Dit moeten klasse-variabelen zijn, omdat je ze in de <code>onDestroy()</code> wil
                            opruimen voor de garbage collection.</li>
                    <li>De volgende stappen moeten allemaal in de <code>onCreate()</code> uitgevoerd worden. Set de DatabaseReference
                        met <code>databaseReference = FirebaseDatabase.getInstance().getReference("messages");</code>
                        <li>Voeg nu een referentie toe naar het RecyclerView veld (hint: <code>findViewById(int)</code>)</li>
                        <li>Omdat de records worden opgeslagen van oud-tot-nieuw is het nodig om de RecyclerView de berichten
                            omgekeerd te laten weergeven (anders zou je dus oude berichten onderaan zien). Dat kan met behulp
                            van de volgende code:</li>
                        <p>
                    <pre><code><span>
LinearLayoutManager layoutManager = new LinearLayoutManager(this);
layoutManager.setStackFromEnd(true);
recyclerView.setLayoutManager(layoutManager);
                    </span></code></pre>
                        </p>
                        <li>Maak nu een nieuwe instantie van de MessageAdapter aan. De constructor vraagt om de List
                            <string>, de username, en de context (gebruik hiervoor gewoon <code>this</code>).</li>
                        <li>Set de adapter van de RecyclerView naar de MessageAdapter die je zojuist hebt aangemaakt.</li>
              </ol>
            </google-codelab-step>
            <google-codelab-step label="Verstuur berichten" step="4" duration="7">
              <p>Wat we nu gaan doen is toevoegen van functionaliteit om berichten te versturen.</p>
                    <ol>
                        <li>Maak een referentie naar de <code>sendMessageButton</code> en voeg hieraan een <code>onClickListener</code> toe die de volgende code uitvoert:</li>
                        <p>
                            <pre><code><span>
SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss", Locale.getDefault());
Message messageToSend = new Message(format.format(new Date()), username, messageEditText.getText().toString());
DatabaseReference uniqueRef = messages.push();
uniqueRef.setValue(messageToSend);
messageEditText.setText("");
                                    </span></code></pre>
                        </p>
                        <aside>
                          <p>Firebase stuurt notificaties naar je DatabaseReference wanneer er een update is (denk hierbij aan
                              nieuwe berichten). Deze kun je vervolgens automatisch herladen in je RecyclerView met behulp
                              van een <code>ValueEventListener</code>.</p>
                        </aside>
                        <li> Declareer een <code>ValueEventListener</code> als klasse variabel (zodat je de
                            listener in <code>onDestroy()</code> weer kan verwijderen van de reference).</li>
                        <p>
                        <pre><code><span>
private ValueEventListener listener = new ValueEventListener() {
    @Override
    public void onDataChange(DataSnapshot dataSnapshot) {
        messagesList.clear();
        for (DataSnapshot snapshot : dataSnapshot.getChildren()) {
            String timestamp = (String) snapshot.child("timestamp").getValue();
            String name = (String) snapshot.child("username").getValue();
            String message = (String) snapshot.child("message").getValue();
            Message receivedMessage = new Message(timestamp, name, message);
            messagesList.add(receivedMessage);
        }
        adapter.notifyDataSetChanged();
        recyclerView.scrollToPosition(adapter.getItemCount() + 1);
    }

    @Override
    public void onCancelled(DatabaseError error) {
        Log.w(this.getClass().getName(), "Failed to read value.", error.toException());
    }
};
                          </span></code></pre>
                            <p>
                                <li>Ten slotte gaan we in de <code>onDestroy()</code> nog even netjes opruimen. Zet de referenties
                                    naar de RecyclerView en Adapter naar <code>null</code>, en verwijder de listener die
                                    je aan de DatabaseReference hebt toegevoegd (hint: <code>databaseReference.removeListener(ValueEventListener)</code>).</li>
                                <li>Start nu je applicatie en begin met chatten!</li>
                </ol>
            </google-codelab-step>
            <google-codelab-step label="Meer leren?" step="5" duration="0">
              <p>
                Je hebt in deze workshop kennis gemaakt met de mogelijkheden van FireBase. Je hebt in relatief korte tijd een chat applicatie gemaakt die synchroniseert over een server met andere gebruikers.
                Daarnaast werkt de applicatie ook offline. Hij slaat dan de berichten die je hebt getypt op en verstuurd deze wanneer je weer internet hebt.
              </p>

              <h2>Wil je nog meer leren over Firebase?</h2>
              <ul>
                <li><a href="https://firebase.google.com/docs/" target="_blank">Lees de documentatie van Firebase eens door.</a></li>
                <li><a href="https://firebase.google.com/docs/samples/" target="_blank">Meer voorbeelden van applicaties die zijn gemaakt met Firebase.</a></li>
                <li><a href="https://firebase.google.com/docs/libraries/" target="_blank">Libraries die zijn gemaakt voor Firebase.</a></li>
              </ul>
            </google-codelab-step>
        </google-codelab>

    </template>

    <script>
Polymer({
    is: 'CodeLab-Firebase-app'
});
</script>
</dom-module>
